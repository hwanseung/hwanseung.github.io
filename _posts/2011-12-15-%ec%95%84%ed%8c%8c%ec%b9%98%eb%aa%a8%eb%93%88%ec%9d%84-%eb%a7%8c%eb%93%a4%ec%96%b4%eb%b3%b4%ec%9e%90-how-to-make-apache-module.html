---
layout: post
title: 아파치모듈을 만들어보자 (How to make Apache module)
date: 2011-12-15 14:43:08.000000000 +09:00
type: post
published: true
status: publish
categories:
- Programing/Web
tags:
- apache
- ubuntu
meta:
  _thumbnail_id: '1941'
  _edit_last: '1'
author: Hwanseung Lee
---
<div>이 포스팅은 아파치 모듈을 만들기 위해 도움이 되고자 합니다.<br />
아파치 모듈도 쓰는 글은 많아도<br />
모듈을 직접만드는 것은 국내 서적도 없을 뿐더라<br />
자료도 거의 구하기 힘들더군요 ㅋㅋㅋ우선 환경은 Ubuntu11.04와 Apache2를 쓴 사용자 기준으로 하겠습니다.</p>
<p>일단 저도 여러 리눅스버전을 쓰다보니 아파치 버전도 다르고 리눅스의<br />
버전마다  아파치에 쓰이는 경로 들이 달라서<br />
Ubuntu11.04에 Apache2를 설치할 경우 어떻게 아파치 경로들이 나오는지<br />
살펴 보겠습니다.</p>
<div>/etc/apache2 &lt;= apache설정파일 위치(httpd.conf, conf.d 등)</div>
<div>/usr/lib/apache2 &lt;= modules 위치</div>
<div>/etc/init.d/apache2 &lt;= stop, start, reload 스크립트</div>
<div>/usr/sbin/a2* 실행파일 &lt;= apache mod, site 설정, 헤제 스크립트</div>
<div>/var/www &lt;= ROOT Home Directory<br />
이렇습니다.본론으로 들어가서<br />
아파치모듈을 만들기 위해 필요한 툴을 설치 해야됩니다.</p>
<div><textarea class="xml" name="code">&lt;br /&gt;<br />
sudo apt-get install apache2-threaded-dev&lt;br /&gt;<br />
</textarea></p>
<div><span class="Apple-style-span" style="color: #000000; font-family: Consolas, 'Courier New', Courier, mono, serif;"><span class="Apple-style-span" style="line-height: 14px;"><span class="Apple-style-span" style="color: #006699;"><b> </b></span></span></span></div>
<div>
<div>위의 명령어로 apxs2를 설치합니다그런한후 .<br />
<span style="color: #000000; font-family: Consolas, 'Courier New', Courier, mono, serif;"><span style="line-height: 14px;"><br />
</span></span><textarea class="xml" name="code">sudo apxs2 -g -n pylatte&lt;br /&gt;<br />
</textarea></p>
</div>
</div>
</div>
</div>
<p>을 명령어를 누르면 아래와 같이 아파치 모듈의 스켈레톤코드를 작성해줍니다.</p>
<p style="margin: 0;"><img class="aligncenter" src="{{ site.baseurl }}/assets/cfile3.uf.19729E404EEA066110976C.png" alt="" width="731" height="472" /></p>
<p>생성된 폴더로 들어가보면 3가지의 파일이 있는데<br />
mod_test_mod.c라고 적혀있는 이 파일에 원하시는 모듈을 작성하시면 됩니다.<br />
여기 나와있는 코드는 아래와 같습니다.</p>
<p><textarea class="cpp" name="code">&lt;br /&gt;<br />
/* &lt;/p&gt;<br />
&lt;p&gt;**  mod_test_mod.c -- Apache sample test_mod module&lt;/p&gt;<br />
&lt;p&gt;**  [Autogenerated via ``apxs -n test_mod -g'']&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**  To play with this sample module first compile it into a&lt;/p&gt;<br />
&lt;p&gt;**  DSO file and install it into Apache's modules directory &lt;/p&gt;<br />
&lt;p&gt;**  by running:&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**    $ apxs -c -i mod_test_mod.c&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**  Then activate it in Apache's apache2.conf file for instance&lt;/p&gt;<br />
&lt;p&gt;**  for the URL /test_mod in as follows:&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**    #   apache2.conf&lt;/p&gt;<br />
&lt;p&gt;**    LoadModule test_mod_module modules/mod_test_mod.so&lt;/p&gt;<br />
&lt;p&gt;**    &lt;Location /test_mod&gt;&lt;/p&gt;<br />
&lt;p&gt;**    SetHandler test_mod&lt;/p&gt;<br />
&lt;p&gt;**    &lt;/Location&gt;&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**  Then after restarting Apache via&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**    $ apachectl restart&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**  you immediately can request the URL /test_mod and watch for the&lt;/p&gt;<br />
&lt;p&gt;**  output of this module. This can be achieved for instance via:&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**    $ lynx -mime_header http://localhost/test_mod &lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**  The output should be similar to the following one:&lt;/p&gt;<br />
&lt;p&gt;**&lt;/p&gt;<br />
&lt;p&gt;**    HTTP/1.1 200 OK&lt;/p&gt;<br />
&lt;p&gt;**    Date: Tue, 31 Mar 1998 14:42:22 GMT&lt;/p&gt;<br />
&lt;p&gt;**    Server: Apache/1.3.4 (Unix)&lt;/p&gt;<br />
&lt;p&gt;**    Connection: close&lt;/p&gt;<br />
&lt;p&gt;**    Content-Type: text/html&lt;/p&gt;<br />
&lt;p&gt;**  &lt;/p&gt;<br />
&lt;p&gt;**    The sample page from mod_test_mod.c&lt;/p&gt;<br />
&lt;p&gt;*/ &lt;/p&gt;<br />
&lt;p&gt;#include "httpd.h"&lt;/p&gt;<br />
&lt;p&gt;#include "http_config.h"&lt;/p&gt;<br />
&lt;p&gt;#include "http_protocol.h"&lt;/p&gt;<br />
&lt;p&gt;#include "ap_config.h"&lt;/p&gt;<br />
&lt;p&gt;/* The sample content handler */&lt;/p&gt;<br />
&lt;p&gt;static int test_mod_handler(request_rec *r)&lt;/p&gt;<br />
&lt;p&gt;{&lt;/p&gt;<br />
&lt;p&gt;    if (strcmp(r-&gt;handler, "test_mod")) {&lt;/p&gt;<br />
&lt;p&gt;        return DECLINED;&lt;/p&gt;<br />
&lt;p&gt;    }&lt;/p&gt;<br />
&lt;p&gt;    r-&gt;content_type = "text/html";      &lt;/p&gt;<br />
&lt;p&gt;    if (!r-&gt;header_only)&lt;/p&gt;<br />
&lt;p&gt;        ap_rputs("The sample page from mod_test_mod.c\n", r);&lt;/p&gt;<br />
&lt;p&gt;    return OK;&lt;/p&gt;<br />
&lt;p&gt;}&lt;/p&gt;<br />
&lt;p&gt;static void test_mod_register_hooks(apr_pool_t *p)&lt;/p&gt;<br />
&lt;p&gt;{&lt;/p&gt;<br />
&lt;p&gt;    ap_hook_handler(test_mod_handler, NULL, NULL, APR_HOOK_MIDDLE);&lt;/p&gt;<br />
&lt;p&gt;}&lt;/p&gt;<br />
&lt;p&gt;/* Dispatch list for API hooks */&lt;/p&gt;<br />
&lt;p&gt;module AP_MODULE_DECLARE_DATA test_mod_module = {&lt;/p&gt;<br />
&lt;p&gt;    STANDARD20_MODULE_STUFF, &lt;/p&gt;<br />
&lt;p&gt;    NULL,                  /* create per-dir    config structures */&lt;/p&gt;<br />
&lt;p&gt;    NULL,                  /* merge  per-dir    config structures */&lt;/p&gt;<br />
&lt;p&gt;    NULL,                  /* create per-server config structures */&lt;/p&gt;<br />
&lt;p&gt;    NULL,                  /* merge  per-server config structures */&lt;/p&gt;<br />
&lt;p&gt;    NULL,                  /* table of config file commands       */&lt;/p&gt;<br />
&lt;p&gt;    test_mod_register_hooks  /* register hooks                      */&lt;/p&gt;<br />
&lt;p&gt;};&lt;/p&gt;<br />
&lt;p&gt;</textarea></p>
<div><span style="color: #006699; font-family: Consolas, 'Courier New', Courier, mono, serif;"><span style="line-height: 14px;"><b> </b></span></span></div>
<p>위의 주석부분에 보면 감사하게도 어떻게 하면 되는지 다 적혀 있습니다.</p>
<p>주석에 있는데로</p>
</div>
<p><textarea class="xml" name="code">sudo apxs2 -c -i mod_pylatte.c&lt;br /&gt;<br />
</textarea><br />
<span style="font-family: Gulim;">로 컴파일 해주시면 자동으로 </span><br />
<span class="comment" style="background-color: #f8f8f8; border-image: initial; color: #008200; font-family: Consolas, 'Courier New', Courier, mono, serif; line-height: 14px; padding: 0px; margin: 0px; border: initial none initial;"><span style="font-family: Gulim;">modules/mod_test_mod.so</span></span><span style="color: #000000; font-family: Consolas, 'Courier New', Courier, mono, serif; line-height: 14px; background-color: #f8f8f8;"><span style="font-family: Gulim;"> 라는 파일이 생성이 되며</span></span></p>
<p>&nbsp;</p>
<ol class="dp-cpp" style="border-image: initial; list-style-position: initial; list-style-image: initial; background-color: #e7e5dc; color: #5c5c5c; font-family: Consolas, 'Courier New', Courier, mono, serif; padding: 0px; margin: 0px !important 0px !important 1px !important 45px !important; border: initial none initial;" start="1">
<li class="" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #f8f8f8; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"><span class="comment" style="background-color: inherit; border-image: initial; color: #008200; padding: 0px; margin: 0px; border: 1px none #f8f8f8;"> #   apache2.conf</span> </span></li>
<li class="alt" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #ffffff; color: inherit; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"> </span></li>
<li class="" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #f8f8f8; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"><span class="comment" style="background-color: inherit; border-image: initial; color: #008200; padding: 0px; margin: 0px; border: 1px none #f8f8f8;">**    LoadModule test_mod_module modules/mod_test_mod.so</span> </span></li>
<li class="alt" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #ffffff; color: inherit; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"> </span></li>
<li class="" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #f8f8f8; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"><span class="comment" style="background-color: inherit; border-image: initial; color: #008200; padding: 0px; margin: 0px; border: 1px none #f8f8f8;">**    &lt;Location /test_mod&gt;</span> </span></li>
<li class="alt" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #ffffff; color: inherit; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"> </span></li>
<li class="" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #f8f8f8; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"><span class="comment" style="background-color: inherit; border-image: initial; color: #008200; padding: 0px; margin: 0px; border: 1px none #f8f8f8;">**    SetHandler test_mod</span> </span></li>
<li class="alt" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #ffffff; color: inherit; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"> </span></li>
<li class="" style="border-width: initial; border-color: initial; border-image: initial; list-style-type: decimal-leading-zero; list-style-image: initial; list-style-position: outside !important; border-left-width: 3px; border-left-color: #6ce26c; background-color: #f8f8f8; line-height: 14px; border-style: none none none solid; padding: 0px !important 3px !important 0px !important 10px !important; margin: 0px !important;"><span style="border-image: initial; color: black; background-color: inherit; padding: 0px; margin: 0px; border: initial none initial;"><span class="comment" style="background-color: inherit; border-image: initial; color: #008200; padding: 0px; margin: 0px; border: 1px none #f8f8f8;">**    &lt;/Location&gt;</span> </span></li>
</ol>
<p><span style="color: #000000; font-family: Consolas, 'Courier New', Courier, mono, serif; line-height: 14px; background-color: #f8f8f8;"> </span> 다음과 같이 apach2.conf에 설정을 해주시고</p>
<p>아파치를 재가동후 접속하시면 자신이 만들었던 모듈이 돌아가게 됩니다.~</p>
